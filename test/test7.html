<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Marked in the browser</title>
</head>
<body>
  <div id="content"></div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.getElementById('content').innerHTML =
      marked.parse('"<h1>导出</h1>\n<pre><code class=\"language-js\">    expHandler () {\n      // 导出消息提示\n      const loading = this.$loading({\n        lock: true,\n        text: &#39;正在导出&#39;,\n        spinner: &#39;el-icon-loading&#39;,\n        background: &#39;rgba(0, 0, 0, 0.7)&#39;\n      })\n      // 导出状态，是否为加载中\n      this.expLoading = true\n      // 获取请求参数\n      let params = JSON.parse(JSON.stringify(this.formData))\n      if (params.time &amp;&amp; params.time.length &gt; 0) {\n        params.startTime = params.time[0]\n        params.endTime = params.time[1]\n      }\n      params.success = this.archiveStatus\n      if (params.success === 0) params.success = &#39;&#39;\n      if (!params.key) delete params.key\n      if (!params.schoolId) delete params.schoolId\n      if (!params.timePlatform) delete params.timePlatform\n      delete params.time\n      delete params.page\n      // 发送请求\n      this.$axios({\n        // 请求方法为post\n        method: &#39;post&#39;,\n        // 请求头为application/octet-stream,二进制流，不知道下载文件类型\n        header: { &#39;Content-Type&#39;: &#39;application/octet-stream&#39; },\n        // 响应类型为blob，二进制大对象，用于存储二进制数据\n        responseType: &#39;blob&#39;,\n        url: &#39;/admin/system/api/exportArchiveLog&#39;,\n        data: { ...params }\n      }).then(res =&gt; {\n        // 获取响应头中的content-disposition，获取文件名\n        const disposition = res.headers[&#39;content-disposition&#39;]\n        const disArr = disposition ? disposition.split(&#39;;&#39;) : []\n        let fileName = &#39;&#39;\n        for (let i = 0, len = disArr.length; i &lt; len; i++) {\n          if (disArr[i].indexOf(&#39;filename=&#39;) &gt; -1) {\n            fileName = decodeURIComponent(disArr[i].split(&#39;=&#39;)[1])\n          }\n        }\n        // 创建a标签，设置href为blob对象地址，设置download为文件名\n        const blob = new Blob([res.data], { type: &#39;application/octet-stream&#39; })\n        const link = document.createElement(&#39;a&#39;)\n        link.href = window.URL.createObjectURL(blob)\n        link.download = fileName ? fileName.replace(/&quot;/g, &#39;&#39;) : fileName\n        // 模拟点击a标签，下载文件\n        document.body.appendChild(link)\n        link.click()\n        // 删除a标签，释放内存\n        document.body.removeChild(link)\n        window.URL.revokeObjectURL(link.href)\n        // 关闭导出提示\n        loading.close()\n        this.expLoading = false\n        this.$message.success(&#39;已成功导出，留意浏览器下载内容&#39;)\n      }).catch(() =&gt; {\n        loading.close()\n        this.expLoading = false\n      })\n    },\n</code></pre>\n<ol>\n<li>获取请求数据数据</li>\n<li>发送请求，方法为post，header为application/octet-stream，responseType为blob<ul>\n<li>application/octet-stream：二进制流，不知道下载文件类型</li>\n<li>blob：二进制大对象，用于存储二进制数据</li>\n</ul>\n</li>\n<li>通过响应头中的content-disposition，获取文件名 数据为attachment;filename=archiveLog.xlsx</li>\n<li>获取文件名 archiveLog.xlsx</li>\n<li>使用blob对象存储数据 <code>const blob = new Blob([res.data], { type: &#39;application/octet-stream&#39; })</code> 意思是这个blob对象存储的是二进制流数据<ul>\n<li>格式为 <code>const blob = new Blob([数据], { type: &#39;文件类型&#39; })</code></li>\n</ul>\n</li>\n<li>创建一个a标签，然后这个a标签的href属性为blob对象的url，download属性为文件名</li>\n<li>生成a标签后，模拟点击a标签，下载文件</li>\n<li>然后删除a标签，释放内存</li>\n</ol>\n<pre><code class=\"language-js\">    expHandler () {\n      // 导出消息提示\n      const loading = this.$loading({\n        lock: true,\n        text: &#39;正在导出&#39;,\n        spinner: &#39;el-icon-loading&#39;,\n        background: &#39;rgba(0, 0, 0, 0.7)&#39;\n      })\n      // 导出状态，是否为加载中\n      this.expLoading = true\n      // 获取请求参数\n      let params = JSON.parse(JSON.stringify(this.formData))\n      if (params.time &amp;&amp; params.time.length &gt; 0) {\n        params.startTime = params.time[0]\n        params.endTime = params.time[1]\n      }\n      params.success = this.archiveStatus\n      if (params.success === 0) params.success = &#39;&#39;\n      if (!params.key) delete params.key\n      if (!params.schoolId) delete params.schoolId\n      if (!params.timePlatform) delete params.timePlatform\n      delete params.time\n      delete params.page\n      // 发送请求\n      this.$axios({\n        // 请求方法为post\n        method: &#39;post&#39;,\n        // 请求头为application/octet-stream,二进制流，不知道下载文件类型\n        header: { &#39;Content-Type&#39;: &#39;application/octet-stream&#39; },\n        // 响应类型为blob，二进制大对象，用于存储二进制数据\n        responseType: &#39;blob&#39;,\n        url: &#39;/admin/system/api/exportArchiveLog&#39;,\n        data: { ...params }\n      }).then(res =&gt; {\n        // 获取响应头中的content-disposition，获取文件名\n        const disposition = res.headers[&#39;content-disposition&#39;]\n        const disArr = disposition ? disposition.split(&#39;;&#39;) : []\n        let fileName = &#39;&#39;\n        for (let i = 0, len = disArr.length; i &lt; len; i++) {\n          if (disArr[i].indexOf(&#39;filename=&#39;) &gt; -1) {\n            fileName = decodeURIComponent(disArr[i].split(&#39;=&#39;)[1])\n          }\n        }\n        // 创建a标签，设置href为blob对象地址，设置download为文件名\n        const blob = new Blob([res.data], { type: &#39;application/octet-stream&#39; })\n        const link = document.createElement(&#39;a&#39;)\n        link.href = window.URL.createObjectURL(blob)\n        link.download = fileName ? fileName.replace(/&quot;/g, &#39;&#39;) : fileName\n        // 模拟点击a标签，下载文件\n        document.body.appendChild(link)\n        link.click()\n        // 删除a标签，释放内存\n        document.body.removeChild(link)\n        window.URL.revokeObjectURL(link.href)\n        // 关闭导出提示\n        loading.close()\n        this.expLoading = false\n        this.$message.success(&#39;已成功导出，留意浏览器下载内容&#39;)\n      }).catch(() =&gt; {\n        loading.close()\n        this.expLoading = false\n      })\n    },\n</code></pre>\n"');
  </script>
</body>
</html>
